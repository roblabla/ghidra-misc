# Ghidra Misc

Repository with various configs, scripts and patches to make ghidra better.

Hopefully, the patches will go upstream when the NSA properly open sources
everything.


# AArch64 Volatile System Registers

When decompiling privileged aarch64 binaries, such as kernels or hypervisor,
the decompiler will ignore any writes to the System Registers, as they are not
marked volatile. This can cause surprising and unintuitive misdecompilations.

The fix is simple: in `../Ghidra/Processors/AARCH64/data/languages/AARCH64.pspec`,
change the `<volatile>` region to the following:

```xml
  <volatile outputop="cWrite" inputop="cRead">
	  <!-- PATCHES: roblabla -->
    <range space="register" first="0x1000" last="0x3fff"/>
  </volatile>
```

(This simply changes first to 0x1000). The reason why is simple: System
Registers are mapped to start at 0x1100 in `AARCH64instructions.sinc`, so we
should ensure they are in the volatile region. Furthermore, the general
registers only start at 0x4000, so everything before that can safely be marked
as volatile.

# AArch64 Better CallSystemMonitor

The CallSystemMonitor pseudo-op is frustratingly limited: it doesn't trash the
registers, leading to extreme misdecompiles on targets that trash it (such as
the Horizon SecMon). Less problematic but just as annoying, it doesn't show the
registers used for the syscall. To fix it, we're going to fix the p-code
generated by the `smc` instruction to properly account for this.

In `../Ghidra/Processors/AARCH64/data/languages/AARCH64base.sinc`

```
:smc imm16
is b_2431=0xd4 & excCode=0 & imm16 & excCode2=0 & ll=3
{
# PATCHES: roblabla
	tmpptr:8 = 0;
	# TODO: Can't put more than 6 arguments here. If I add x6/x7, the pcode
	# becomes "unimpl". Seems to be an inherent limitation of the sleigh
	# compiler.
	tmpptr = CallSecureMonitor(imm16:2, x0, x1, x2, x3, x4, x5);
	x0 = *tmpptr;
	x1 = *(tmpptr + 0x08);
	x2 = *(tmpptr + 0x10);
	x3 = *(tmpptr + 0x18);
	x4 = *(tmpptr + 0x20);
	x5 = *(tmpptr + 0x28);
	x6 = *(tmpptr + 0x30);
	x7 = *(tmpptr + 0x38);
}
```
